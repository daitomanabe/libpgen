

<html >
	<head>
	<title>Packet Class - Libpgen Document</title>	

	<link rel="stylesheet" type="text/css" href="../style.css">
	</head>

		<body>


<h1>パケットキャプチャ　- sample program</h1>

インストールは完了したので、libpgen初めてのプログラミングとして、簡単なパケットキャプチャを作成してみましょう。
このプログラムはとてもシンプルで数行でコーディングできる規模でありながらlibpgenのパケット受信機能のほとんどを
理解することができます。

パケットキャプチャのサンプルコードを以下に示します。

<h2>サンプルコード</h2>

<pre><code>

	/* capture.cc */ 
	#include &lt;pgen.h&gt;
	bool callback(const u_cahr,int);

	int main(int argc, char** argv){
		if(argc &lt; 2){
			printf("Usage: %s interface \n", argv[0]);
			return -1;
		}
		pgen_handle* handle = pgen_open(argv[1], NULL); /* open pgen handler */
		if(handle == NULL){
			printf("error \n");
			return -1;
		}
		sniff(handle, callback);
	}

	bool callback(const u_cahr data, int len){
		pgen_unknown buf;
		buf.cast(data, len);
		buf.summary();
		return true;
	}

</pre></code>

<p>プログラムのソースコードはこれで以上です。たった20数行のコードでパケットキャプチャプログラムの完成です。
ソースコードの説明は後にしてまずは実行してみましょう。</p>

<p>コンパイルはg++でコンパイルし、ライブラリのオプションとして -lpgenを追加してください。
libpgenはネットワークインターフェースを扱うときは常にraw socketを使用するので、送受信を行うプログラムの場合は
管理者権限で実行してください。</p>

<pre>
	$ g++ -o capture capture.cc -lpgen
	$ sudo ./capture wlan0
</pre>

<p>パケットキャプチャを体感できたところでソースコードを解説していきたいところですが、始めにlibpgenの基本的な
使い方について説明します。
libpgenはパケット作成、送受信、解析をする機能を含んでいます。今回のパケットキャプチャでは受信、解析を行います。
パケットの受信にはsniff関数を使用します。パケット解析にはパケットクラスを使用します。パケットクラスは
一つ一つのパケット単位で解析、編集、送信などの操作をすることができます。それでは以下でプログラムの説明を
していきます。</p>


<h3>2行目</h3>
libpgenを使用する場合はpgen.hをインクルードします。このヘッダのみでlibpgenのすべての機能を使用るすことができます。

<h3>3行目</h3>
パケット受信用の関数sniffで呼び出すコールバック関数callbackのプロトタイプ宣言です。
詳しい説明はsniffの呼び出し側で説明をします。

<h3>main関数内</h3>
最初の4行はコマンドライン引数のチェック
次の5行はlibpgenでネットワークインターフェースを扱うディスクリプタをpgen_open関数で開きます。
pgen_open関数は第一引数で指定したネットワークインターフェースを開きます。成功時はディスクリプタのポインタ、
失敗時はNULLを返します。
libpgenはこのディスクリプタの概念を使用しなくてもネットワークインターフェースを使用することができるのですが、
高度なプログラミングや、送受信行うプログラミングをする場合はなるべくこの方法でネットワークインターフェースに
アクセスするようにしましょう。
sniff関数でパケット受信をします。第1引数でディスクリプタ、第2引数でパケット受信時に呼び出されるコールバック関数を
指定します。第2引数で指定するコールバック関数のプロトタイプは以下のようにします。
	bool callback_function(const u_char* data, int len);
sniff関数はパケットを受信待機して、受信したらパケットデータの先頭アドレスと受信パケットの長さをそれぞれ、
data, lenとしてコールバック関数の引数で渡してコールバック関数を実行します。コールバック関数がtrueを返した場合
もう一度受信待機をし、falseを返した場合は受信待機はせず次の処理へと移ります。

<h3>callback関数内</h3>
この関数はsniffのコールバック関数として呼ばれ、受信したパケットを解析して、情報表示をします。
1行目はpgenのパケットクラスの一つ unknown型のパケットクラスのインスタンスを生成しています。
2行目は受信したパケットのデータをunknown型パケットクラスに渡して解析をさせます。
pgen_unknown型のパケットクラスはパケットがEthernet, ARP, IP, TCP, UDPかを判断し、Ethernet, ARP以下なら送受信MAC
アドレスを解析し、IP以下なら送受信IPアドレスを解析します。TCP,UDPの場合は送受信ポート番号も解析します。
2行目は情報出力を行います。1行目で解析した内容でbufインスタンスに情報が蓄積されたので、summaryメンバ関数は
その情報を1行で、簡単に表示します。
3行目でtrueを返して、sniff関数を再度受信待機状態にします。



</body></html>
